version: '3.8'\n\nservices:\n  # 后端应用\n  backend:\n    image: ${DOCKER_REGISTRY}/quant-framework:${IMAGE_TAG}\n    deploy:\n      replicas: 3\n      restart_policy:\n        condition: on-failure\n        delay: 5s\n        max_attempts: 3\n      resources:\n        limits:\n          cpus: '2.0'\n          memory: 4G\n        reservations:\n          cpus: '1.0'\n          memory: 2G\n    environment:\n      - ENVIRONMENT=production\n      - DEBUG=false\n      - DATABASE_URL=${DATABASE_URL}\n      - REDIS_URL=${REDIS_URL}\n      - SECRET_KEY=${SECRET_KEY}\n      - TUSHARE_TOKEN=${TUSHARE_TOKEN}\n      - LOG_LEVEL=INFO\n    volumes:\n      - backend_logs:/app/logs\n      - backend_cache:/app/data/cache\n    networks:\n      - quant-network\n    healthcheck:\n      test: [\"CMD\", \"curl\", \"-f\", \"http://localhost:8000/health\"]\n      interval: 30s\n      timeout: 10s\n      retries: 3\n      start_period: 60s\n  \n  # Celery Worker\n  worker:\n    image: ${DOCKER_REGISTRY}/quant-framework:${IMAGE_TAG}\n    deploy:\n      replicas: 2\n      restart_policy:\n        condition: on-failure\n        delay: 5s\n        max_attempts: 3\n      resources:\n        limits:\n          cpus: '2.0'\n          memory: 4G\n        reservations:\n          cpus: '1.0'\n          memory: 2G\n    environment:\n      - ENVIRONMENT=production\n      - DATABASE_URL=${DATABASE_URL}\n      - REDIS_URL=${REDIS_URL}\n      - SECRET_KEY=${SECRET_KEY}\n      - TUSHARE_TOKEN=${TUSHARE_TOKEN}\n      - LOG_LEVEL=INFO\n    volumes:\n      - worker_logs:/app/logs\n      - worker_cache:/app/data/cache\n    networks:\n      - quant-network\n    command: celery -A quant_framework.core.celery worker --loglevel=info --concurrency=8 --max-tasks-per-child=1000\n  \n  # Celery Beat\n  beat:\n    image: ${DOCKER_REGISTRY}/quant-framework:${IMAGE_TAG}\n    deploy:\n      replicas: 1\n      restart_policy:\n        condition: on-failure\n        delay: 5s\n        max_attempts: 3\n    environment:\n      - ENVIRONMENT=production\n      - DATABASE_URL=${DATABASE_URL}\n      - REDIS_URL=${REDIS_URL}\n      - SECRET_KEY=${SECRET_KEY}\n      - TUSHARE_TOKEN=${TUSHARE_TOKEN}\n    volumes:\n      - beat_logs:/app/logs\n    networks:\n      - quant-network\n    command: celery -A quant_framework.core.celery beat --loglevel=info\n  \n  # 前端应用\n  frontend:\n    image: ${DOCKER_REGISTRY}/quant-framework-frontend:${IMAGE_TAG}\n    deploy:\n      replicas: 2\n      restart_policy:\n        condition: on-failure\n        delay: 5s\n        max_attempts: 3\n      resources:\n        limits:\n          cpus: '0.5'\n          memory: 512M\n        reservations:\n          cpus: '0.25'\n          memory: 256M\n    networks:\n      - quant-network\n    healthcheck:\n      test: [\"CMD\", \"wget\", \"--quiet\", \"--tries=1\", \"--spider\", \"http://localhost/health\"]\n      interval: 30s\n      timeout: 10s\n      retries: 3\n  \n  # Nginx负载均衡\n  nginx:\n    image: nginx:alpine\n    ports:\n      - \"80:80\"\n      - \"443:443\"\n    volumes:\n      - ./nginx/prod.conf:/etc/nginx/nginx.conf:ro\n      - ./ssl:/etc/ssl:ro\n      - nginx_logs:/var/log/nginx\n    depends_on:\n      - backend\n      - frontend\n    networks:\n      - quant-network\n    deploy:\n      replicas: 2\n      restart_policy:\n        condition: on-failure\n    healthcheck:\n      test: [\"CMD\", \"wget\", \"--quiet\", \"--tries=1\", \"--spider\", \"http://localhost/health\"]\n      interval: 30s\n      timeout: 10s\n      retries: 3\n\nvolumes:\n  backend_logs:\n    driver: local\n  worker_logs:\n    driver: local\n  beat_logs:\n    driver: local\n  backend_cache:\n    driver: local\n  worker_cache:\n    driver: local\n  nginx_logs:\n    driver: local\n\nnetworks:\n  quant-network:\n    driver: overlay\n    attachable: true\n\n# 外部服务配置（生产环境使用外部数据库和Redis）\n# postgres:\n#   external: true\n# redis:\n#   external: true\n