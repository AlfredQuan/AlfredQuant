# 部署和运维指南\n\n## 概述\n\n本指南详细介绍量化投资研究框架的部署方案、运维管理和监控告警，涵盖开发、测试、生产等不同环境的部署策略。\n\n## 系统架构\n\n### 整体架构\n\n```\n┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐\n│   Load Balancer │    │   Web Frontend  │    │   Mobile App    │\n│    (Nginx)      │    │    (React)      │    │   (Optional)    │\n└─────────────────┘    └─────────────────┘    └─────────────────┘\n         │                       │                       │\n         └───────────────────────┼───────────────────────┘\n                                 │\n         ┌─────────────────────────────────────────────────────┐\n         │                API Gateway                          │\n         │              (FastAPI)                             │\n         └─────────────────────────────────────────────────────┘\n                                 │\n    ┌────────────────────────────┼────────────────────────────┐\n    │                            │                            │\n┌───▼────┐  ┌──────────┐  ┌─────▼─────┐  ┌──────────┐  ┌────▼────┐\n│Strategy│  │Backtest  │  │  Trading  │  │   Data   │  │  Risk   │\n│Service │  │ Engine   │  │  Engine   │  │ Service  │  │ Service │\n└────────┘  └──────────┘  └───────────┘  └──────────┘  └─────────┘\n     │           │              │              │              │\n     └───────────┼──────────────┼──────────────┼──────────────┘\n                 │              │              │\n         ┌───────▼──────────────▼──────────────▼───────┐\n         │              Message Queue                  │\n         │               (Redis)                       │\n         └─────────────────────────────────────────────┘\n                                 │\n         ┌─────────────────────────────────────────────────────┐\n         │                  Database                           │\n         │              (PostgreSQL)                          │\n         └─────────────────────────────────────────────────────┘\n```\n\n### 技术栈\n\n- **前端**: React 18 + TypeScript + Ant Design\n- **后端**: Python 3.11 + FastAPI + SQLAlchemy\n- **数据库**: PostgreSQL 13+ (主数据库) + Redis 6+ (缓存)\n- **消息队列**: Redis + Celery\n- **Web服务器**: Nginx\n- **容器化**: Docker + Docker Compose\n- **编排**: Kubernetes (生产环境)\n- **监控**: Prometheus + Grafana\n- **日志**: ELK Stack (Elasticsearch + Logstash + Kibana)\n\n## 环境准备\n\n### 硬件要求\n\n#### 开发环境\n- CPU: 4核心以上\n- 内存: 8GB以上\n- 存储: 100GB以上SSD\n- 网络: 稳定的互联网连接\n\n#### 测试环境\n- CPU: 8核心以上\n- 内存: 16GB以上\n- 存储: 500GB以上SSD\n- 网络: 100Mbps以上\n\n#### 生产环境\n- CPU: 16核心以上\n- 内存: 32GB以上\n- 存储: 1TB以上SSD (数据库) + 500GB SSD (应用)\n- 网络: 1Gbps以上\n- 备份存储: 2TB以上\n\n### 软件要求\n\n#### 基础软件\n- 操作系统: Ubuntu 20.04 LTS 或 CentOS 8+\n- Docker: 20.10+\n- Docker Compose: 2.0+\n- Git: 2.25+\n\n#### 可选软件\n- Kubernetes: 1.24+\n- Helm: 3.8+\n- Terraform: 1.0+ (基础设施即代码)\n\n## 本地开发环境\n\n### 使用Docker Compose\n\n1. **克隆项目**\n```bash\ngit clone https://github.com/your-org/quant-framework.git\ncd quant-framework\n```\n\n2. **配置环境变量**\n```bash\ncp .env.example .env.local\nvim .env.local\n```\n\n```bash\n# .env.local\nENVIRONMENT=development\nDEBUG=true\n\n# 数据库配置\nDATABASE_URL=postgresql://postgres:password@localhost:5432/quant_framework_dev\nREDIS_URL=redis://localhost:6379/0\n\n# 安全配置\nSECRET_KEY=dev-secret-key-change-in-production\nACCESS_TOKEN_EXPIRE_MINUTES=1440\n\n# 数据源配置\nTUSHARE_TOKEN=your-tushare-token\n\n# 日志配置\nLOG_LEVEL=DEBUG\nLOG_FILE=logs/app.log\n```\n\n3. **启动服务**\n```bash\n# 启动所有服务\ndocker-compose -f docker-compose.dev.yml up -d\n\n# 查看服务状态\ndocker-compose -f docker-compose.dev.yml ps\n\n# 查看日志\ndocker-compose -f docker-compose.dev.yml logs -f app\n```\n\n4. **初始化数据**\n```bash\n# 运行数据库迁移\ndocker-compose -f docker-compose.dev.yml exec app python scripts/migrate.py upgrade\n\n# 初始化基础数据\ndocker-compose -f docker-compose.dev.yml exec app python scripts/init_data.py init\n\n# 创建管理员用户\ndocker-compose -f docker-compose.dev.yml exec app python scripts/create_admin.py\n```\n\n### 开发环境配置文件\n\n```yaml\n# docker-compose.dev.yml\nversion: '3.8'\n\nservices:\n  app:\n    build:\n      context: .\n      dockerfile: Dockerfile.dev\n    ports:\n      - \"8000:8000\"\n    volumes:\n      - .:/app\n      - ./logs:/app/logs\n    environment:\n      - ENVIRONMENT=development\n      - DATABASE_URL=postgresql://postgres:password@db:5432/quant_framework_dev\n      - REDIS_URL=redis://redis:6379/0\n    depends_on:\n      - db\n      - redis\n    command: uvicorn quant_framework.main:app --host 0.0.0.0 --port 8000 --reload\n  \n  db:\n    image: postgres:13\n    environment:\n      - POSTGRES_DB=quant_framework_dev\n      - POSTGRES_USER=postgres\n      - POSTGRES_PASSWORD=password\n    volumes:\n      - postgres_dev_data:/var/lib/postgresql/data\n      - ./scripts/init_db.sql:/docker-entrypoint-initdb.d/init.sql\n    ports:\n      - \"5432:5432\"\n  \n  redis:\n    image: redis:6-alpine\n    ports:\n      - \"6379:6379\"\n    command: redis-server --appendonly yes\n    volumes:\n      - redis_dev_data:/data\n  \n  worker:\n    build:\n      context: .\n      dockerfile: Dockerfile.dev\n    volumes:\n      - .:/app\n      - ./logs:/app/logs\n    environment:\n      - ENVIRONMENT=development\n      - DATABASE_URL=postgresql://postgres:password@db:5432/quant_framework_dev\n      - REDIS_URL=redis://redis:6379/0\n    depends_on:\n      - db\n      - redis\n    command: celery -A quant_framework.core.celery worker --loglevel=info\n  \n  frontend:\n    build:\n      context: ./frontend\n      dockerfile: Dockerfile.dev\n    ports:\n      - \"3000:3000\"\n    volumes:\n      - ./frontend:/app\n      - /app/node_modules\n    environment:\n      - REACT_APP_API_URL=http://localhost:8000/api/v1\n    command: npm start\n\nvolumes:\n  postgres_dev_data:\n  redis_dev_data:\n```\n\n## 测试环境部署\n\n### 自动化部署脚本\n\n```bash\n#!/bin/bash\n# deploy-test.sh\n\nset -e\n\necho \"开始部署测试环境...\"\n\n# 设置变量\nENV=\"test\"\nBRANCH=\"develop\"\nDOCKER_REGISTRY=\"your-registry.com\"\nIMAGE_TAG=\"test-$(date +%Y%m%d-%H%M%S)\"\n\n# 拉取最新代码\necho \"拉取最新代码...\"\ngit fetch origin\ngit checkout $BRANCH\ngit pull origin $BRANCH\n\n# 构建镜像\necho \"构建Docker镜像...\"\ndocker build -t $DOCKER_REGISTRY/quant-framework:$IMAGE_TAG .\ndocker build -t $DOCKER_REGISTRY/quant-framework-frontend:$IMAGE_TAG ./frontend\n\n# 推送镜像\necho \"推送镜像到仓库...\"\ndocker push $DOCKER_REGISTRY/quant-framework:$IMAGE_TAG\ndocker push $DOCKER_REGISTRY/quant-framework-frontend:$IMAGE_TAG\n\n# 更新部署配置\necho \"更新部署配置...\"\nsed -i \"s|image: .*quant-framework:.*|image: $DOCKER_REGISTRY/quant-framework:$IMAGE_TAG|g\" k8s/test/deployment.yaml\nsed -i \"s|image: .*quant-framework-frontend:.*|image: $DOCKER_REGISTRY/quant-framework-frontend:$IMAGE_TAG|g\" k8s/test/frontend-deployment.yaml\n\n# 部署到Kubernetes\necho \"部署到测试环境...\"\nkubectl apply -f k8s/test/\n\n# 等待部署完成\necho \"等待部署完成...\"\nkubectl rollout status deployment/quant-framework -n test\nkubectl rollout status deployment/quant-framework-frontend -n test\n\n# 运行数据库迁移\necho \"运行数据库迁移...\"\nkubectl exec -n test deployment/quant-framework -- python scripts/migrate.py upgrade\n\n# 运行健康检查\necho \"运行健康检查...\"\nsleep 30\nHEALTH_URL=\"http://test.quant-framework.com/health\"\nif curl -f $HEALTH_URL; then\n    echo \"✅ 测试环境部署成功！\"\n    echo \"访问地址: http://test.quant-framework.com\"\nelse\n    echo \"❌ 健康检查失败，请检查部署状态\"\n    exit 1\nfi\n\necho \"部署完成！\"\n```\n\n### 测试环境配置\n\n```yaml\n# k8s/test/deployment.yaml\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: quant-framework\n  namespace: test\n  labels:\n    app: quant-framework\n    env: test\nspec:\n  replicas: 2\n  selector:\n    matchLabels:\n      app: quant-framework\n      env: test\n  template:\n    metadata:\n      labels:\n        app: quant-framework\n        env: test\n    spec:\n      containers:\n      - name: app\n        image: your-registry.com/quant-framework:latest\n        ports:\n        - containerPort: 8000\n        env:\n        - name: ENVIRONMENT\n          value: \"test\"\n        - name: DATABASE_URL\n          valueFrom:\n            secretKeyRef:\n              name: quant-framework-secrets\n              key: database-url\n        - name: REDIS_URL\n          valueFrom:\n            secretKeyRef:\n              name: quant-framework-secrets\n              key: redis-url\n        - name: SECRET_KEY\n          valueFrom:\n            secretKeyRef:\n              name: quant-framework-secrets\n              key: secret-key\n        resources:\n          requests:\n            memory: \"1Gi\"\n            cpu: \"500m\"\n          limits:\n            memory: \"2Gi\"\n            cpu: \"1000m\"\n        livenessProbe:\n          httpGet:\n            path: /health\n            port: 8000\n          initialDelaySeconds: 60\n          periodSeconds: 30\n        readinessProbe:\n          httpGet:\n            path: /ready\n            port: 8000\n          initialDelaySeconds: 30\n          periodSeconds: 10\n        volumeMounts:\n        - name: logs\n          mountPath: /app/logs\n      volumes:\n      - name: logs\n        persistentVolumeClaim:\n          claimName: quant-framework-logs\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: quant-framework-service\n  namespace: test\nspec:\n  selector:\n    app: quant-framework\n    env: test\n  ports:\n  - protocol: TCP\n    port: 80\n    targetPort: 8000\n  type: ClusterIP\n```\n\n## 生产环境部署\n\n### 高可用架构\n\n```yaml\n# k8s/prod/deployment.yaml\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: quant-framework\n  namespace: prod\n  labels:\n    app: quant-framework\n    env: prod\nspec:\n  replicas: 5\n  strategy:\n    type: RollingUpdate\n    rollingUpdate:\n      maxSurge: 1\n      maxUnavailable: 1\n  selector:\n    matchLabels:\n      app: quant-framework\n      env: prod\n  template:\n    metadata:\n      labels:\n        app: quant-framework\n        env: prod\n    spec:\n      affinity:\n        podAntiAffinity:\n          preferredDuringSchedulingIgnoredDuringExecution:\n          - weight: 100\n            podAffinityTerm:\n              labelSelector:\n                matchExpressions:\n                - key: app\n                  operator: In\n                  values:\n                  - quant-framework\n              topologyKey: kubernetes.io/hostname\n      containers:\n      - name: app\n        image: your-registry.com/quant-framework:v1.0.0\n        ports:\n        - containerPort: 8000\n        env:\n        - name: ENVIRONMENT\n          value: \"production\"\n        - name: DATABASE_URL\n          valueFrom:\n            secretKeyRef:\n              name: quant-framework-secrets\n              key: database-url\n        - name: REDIS_URL\n          valueFrom:\n            secretKeyRef:\n              name: quant-framework-secrets\n              key: redis-url\n        - name: SECRET_KEY\n          valueFrom:\n            secretKeyRef:\n              name: quant-framework-secrets\n              key: secret-key\n        resources:\n          requests:\n            memory: \"2Gi\"\n            cpu: \"1000m\"\n          limits:\n            memory: \"4Gi\"\n            cpu: \"2000m\"\n        livenessProbe:\n          httpGet:\n            path: /health\n            port: 8000\n          initialDelaySeconds: 120\n          periodSeconds: 30\n          timeoutSeconds: 10\n          failureThreshold: 3\n        readinessProbe:\n          httpGet:\n            path: /ready\n            port: 8000\n          initialDelaySeconds: 60\n          periodSeconds: 10\n          timeoutSeconds: 5\n          failureThreshold: 3\n        volumeMounts:\n        - name: logs\n          mountPath: /app/logs\n        - name: config\n          mountPath: /app/config\n          readOnly: true\n      volumes:\n      - name: logs\n        persistentVolumeClaim:\n          claimName: quant-framework-logs\n      - name: config\n        configMap:\n          name: quant-framework-config\n```\n\n### 数据库高可用\n\n```yaml\n# k8s/prod/postgres-ha.yaml\napiVersion: postgresql.cnpg.io/v1\nkind: Cluster\nmetadata:\n  name: postgres-cluster\n  namespace: prod\nspec:\n  instances: 3\n  \n  postgresql:\n    parameters:\n      max_connections: \"200\"\n      shared_buffers: \"256MB\"\n      effective_cache_size: \"1GB\"\n      maintenance_work_mem: \"64MB\"\n      checkpoint_completion_target: \"0.9\"\n      wal_buffers: \"16MB\"\n      default_statistics_target: \"100\"\n      random_page_cost: \"1.1\"\n      effective_io_concurrency: \"200\"\n      work_mem: \"4MB\"\n      min_wal_size: \"1GB\"\n      max_wal_size: \"4GB\"\n  \n  bootstrap:\n    initdb:\n      database: quant_framework\n      owner: app_user\n      secret:\n        name: postgres-credentials\n  \n  storage:\n    size: 100Gi\n    storageClass: fast-ssd\n  \n  monitoring:\n    enabled: true\n  \n  backup:\n    retentionPolicy: \"30d\"\n    barmanObjectStore:\n      destinationPath: \"s3://your-backup-bucket/postgres\"\n      s3Credentials:\n        accessKeyId:\n          name: backup-credentials\n          key: ACCESS_KEY_ID\n        secretAccessKey:\n          name: backup-credentials\n          key: SECRET_ACCESS_KEY\n      wal:\n        retention: \"7d\"\n      data:\n        retention: \"30d\"\n```\n\n### 负载均衡配置\n\n```nginx\n# nginx.conf\nupstream quant_framework_backend {\n    least_conn;\n    server quant-framework-1:8000 max_fails=3 fail_timeout=30s;\n    server quant-framework-2:8000 max_fails=3 fail_timeout=30s;\n    server quant-framework-3:8000 max_fails=3 fail_timeout=30s;\n    server quant-framework-4:8000 max_fails=3 fail_timeout=30s;\n    server quant-framework-5:8000 max_fails=3 fail_timeout=30s;\n}\n\nserver {\n    listen 80;\n    server_name quant-framework.com www.quant-framework.com;\n    return 301 https://$server_name$request_uri;\n}\n\nserver {\n    listen 443 ssl http2;\n    server_name quant-framework.com www.quant-framework.com;\n    \n    ssl_certificate /etc/ssl/certs/quant-framework.crt;\n    ssl_certificate_key /etc/ssl/private/quant-framework.key;\n    ssl_protocols TLSv1.2 TLSv1.3;\n    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384;\n    ssl_prefer_server_ciphers off;\n    ssl_session_cache shared:SSL:10m;\n    ssl_session_timeout 10m;\n    \n    # 安全头\n    add_header Strict-Transport-Security \"max-age=31536000; includeSubDomains\" always;\n    add_header X-Frame-Options DENY always;\n    add_header X-Content-Type-Options nosniff always;\n    add_header X-XSS-Protection \"1; mode=block\" always;\n    add_header Referrer-Policy \"strict-origin-when-cross-origin\" always;\n    \n    # 静态文件\n    location /static/ {\n        alias /var/www/static/;\n        expires 1y;\n        add_header Cache-Control \"public, immutable\";\n    }\n    \n    # API请求\n    location /api/ {\n        proxy_pass http://quant_framework_backend;\n        proxy_set_header Host $host;\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Proto $scheme;\n        \n        # 超时设置\n        proxy_connect_timeout 60s;\n        proxy_send_timeout 60s;\n        proxy_read_timeout 60s;\n        \n        # 缓冲设置\n        proxy_buffering on;\n        proxy_buffer_size 4k;\n        proxy_buffers 8 4k;\n        \n        # 健康检查\n        proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;\n    }\n    \n    # WebSocket支持\n    location /ws/ {\n        proxy_pass http://quant_framework_backend;\n        proxy_http_version 1.1;\n        proxy_set_header Upgrade $http_upgrade;\n        proxy_set_header Connection \"upgrade\";\n        proxy_set_header Host $host;\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Proto $scheme;\n    }\n    \n    # 前端应用\n    location / {\n        try_files $uri $uri/ /index.html;\n        root /var/www/html;\n        index index.html;\n        \n        # 缓存设置\n        location ~* \\.(js|css|png|jpg|jpeg|gif|ico|svg)$ {\n            expires 1y;\n            add_header Cache-Control \"public, immutable\";\n        }\n    }\n    \n    # 健康检查\n    location /health {\n        access_log off;\n        return 200 \"healthy\\n\";\n        add_header Content-Type text/plain;\n    }\n}\n```\n\n## 监控和告警\n\n### Prometheus配置\n\n```yaml\n# prometheus.yml\nglobal:\n  scrape_interval: 15s\n  evaluation_interval: 15s\n\nrule_files:\n  - \"rules/*.yml\"\n\nalerting:\n  alertmanagers:\n    - static_configs:\n        - targets:\n          - alertmanager:9093\n\nscrape_configs:\n  - job_name: 'quant-framework'\n    static_configs:\n      - targets: ['quant-framework:8000']\n    metrics_path: '/metrics'\n    scrape_interval: 30s\n  \n  - job_name: 'postgres'\n    static_configs:\n      - targets: ['postgres-exporter:9187']\n  \n  - job_name: 'redis'\n    static_configs:\n      - targets: ['redis-exporter:9121']\n  \n  - job_name: 'nginx'\n    static_configs:\n      - targets: ['nginx-exporter:9113']\n  \n  - job_name: 'node'\n    static_configs:\n      - targets: ['node-exporter:9100']\n```\n\n### 告警规则\n\n```yaml\n# rules/alerts.yml\ngroups:\n- name: quant-framework\n  rules:\n  - alert: HighErrorRate\n    expr: rate(http_requests_total{status=~\"5..\"}[5m]) > 0.1\n    for: 5m\n    labels:\n      severity: critical\n    annotations:\n      summary: \"High error rate detected\"\n      description: \"Error rate is {{ $value }} errors per second\"\n  \n  - alert: HighResponseTime\n    expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 2\n    for: 5m\n    labels:\n      severity: warning\n    annotations:\n      summary: \"High response time detected\"\n      description: \"95th percentile response time is {{ $value }} seconds\"\n  \n  - alert: DatabaseConnectionHigh\n    expr: pg_stat_activity_count > 150\n    for: 5m\n    labels:\n      severity: warning\n    annotations:\n      summary: \"High database connections\"\n      description: \"Database has {{ $value }} active connections\"\n  \n  - alert: BacktestQueueHigh\n    expr: celery_queue_length{queue=\"backtest\"} > 50\n    for: 10m\n    labels:\n      severity: warning\n    annotations:\n      summary: \"Backtest queue is growing\"\n      description: \"Backtest queue has {{ $value }} pending tasks\"\n  \n  - alert: ServiceDown\n    expr: up == 0\n    for: 1m\n    labels:\n      severity: critical\n    annotations:\n      summary: \"Service is down\"\n      description: \"{{ $labels.job }} service is down\"\n```\n\n### Grafana仪表板\n\n```json\n{\n  \"dashboard\": {\n    \"title\": \"量化投资研究框架监控\",\n    \"panels\": [\n      {\n        \"title\": \"请求量\",\n        \"type\": \"graph\",\n        \"targets\": [\n          {\n            \"expr\": \"rate(http_requests_total[5m])\",\n            \"legendFormat\": \"{{method}} {{endpoint}}\"\n          }\n        ]\n      },\n      {\n        \"title\": \"响应时间\",\n        \"type\": \"graph\",\n        \"targets\": [\n          {\n            \"expr\": \"histogram_quantile(0.50, rate(http_request_duration_seconds_bucket[5m]))\",\n            \"legendFormat\": \"50th percentile\"\n          },\n          {\n            \"expr\": \"histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))\",\n            \"legendFormat\": \"95th percentile\"\n          }\n        ]\n      },\n      {\n        \"title\": \"错误率\",\n        \"type\": \"singlestat\",\n        \"targets\": [\n          {\n            \"expr\": \"rate(http_requests_total{status=~\\\"5..\\\"}[5m]) / rate(http_requests_total[5m])\"\n          }\n        ]\n      },\n      {\n        \"title\": \"活跃回测任务\",\n        \"type\": \"singlestat\",\n        \"targets\": [\n          {\n            \"expr\": \"celery_active_tasks{queue=\\\"backtest\\\"}\"\n          }\n        ]\n      },\n      {\n        \"title\": \"数据库连接\",\n        \"type\": \"graph\",\n        \"targets\": [\n          {\n            \"expr\": \"pg_stat_activity_count\",\n            \"legendFormat\": \"Active connections\"\n          }\n        ]\n      },\n      {\n        \"title\": \"内存使用\",\n        \"type\": \"graph\",\n        \"targets\": [\n          {\n            \"expr\": \"(1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100\",\n            \"legendFormat\": \"Memory usage %\"\n          }\n        ]\n      }\n    ]\n  }\n}\n```\n\n## 日志管理\n\n### ELK Stack配置\n\n```yaml\n# docker-compose.elk.yml\nversion: '3.8'\n\nservices:\n  elasticsearch:\n    image: docker.elastic.co/elasticsearch/elasticsearch:8.5.0\n    environment:\n      - discovery.type=single-node\n      - \"ES_JAVA_OPTS=-Xms2g -Xmx2g\"\n      - xpack.security.enabled=false\n    volumes:\n      - elasticsearch_data:/usr/share/elasticsearch/data\n    ports:\n      - \"9200:9200\"\n  \n  logstash:\n    image: docker.elastic.co/logstash/logstash:8.5.0\n    volumes:\n      - ./logstash/pipeline:/usr/share/logstash/pipeline\n      - ./logstash/config:/usr/share/logstash/config\n    ports:\n      - \"5044:5044\"\n    depends_on:\n      - elasticsearch\n  \n  kibana:\n    image: docker.elastic.co/kibana/kibana:8.5.0\n    environment:\n      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200\n    ports:\n      - \"5601:5601\"\n    depends_on:\n      - elasticsearch\n  \n  filebeat:\n    image: docker.elastic.co/beats/filebeat:8.5.0\n    user: root\n    volumes:\n      - ./filebeat/filebeat.yml:/usr/share/filebeat/filebeat.yml:ro\n      - /var/lib/docker/containers:/var/lib/docker/containers:ro\n      - /var/run/docker.sock:/var/run/docker.sock:ro\n      - ./logs:/app/logs:ro\n    depends_on:\n      - logstash\n\nvolumes:\n  elasticsearch_data:\n```\n\n```yaml\n# filebeat/filebeat.yml\nfilebeat.inputs:\n- type: log\n  enabled: true\n  paths:\n    - /app/logs/*.log\n  fields:\n    service: quant-framework\n    environment: production\n  fields_under_root: true\n  multiline.pattern: '^\\d{4}-\\d{2}-\\d{2}'\n  multiline.negate: true\n  multiline.match: after\n\n- type: container\n  enabled: true\n  paths:\n    - '/var/lib/docker/containers/*/*.log'\n  processors:\n    - add_docker_metadata:\n        host: \"unix:///var/run/docker.sock\"\n\noutput.logstash:\n  hosts: [\"logstash:5044\"]\n\nlogging.level: info\nlogging.to_files: true\nlogging.files:\n  path: /var/log/filebeat\n  name: filebeat\n  keepfiles: 7\n  permissions: 0644\n```\n\n## 备份和恢复\n\n### 数据库备份\n\n```bash\n#!/bin/bash\n# backup-database.sh\n\nset -e\n\n# 配置\nDB_HOST=\"postgres-cluster-rw\"\nDB_NAME=\"quant_framework\"\nDB_USER=\"app_user\"\nBACKUP_DIR=\"/backups/database\"\nS3_BUCKET=\"your-backup-bucket\"\nRETENTION_DAYS=30\n\n# 创建备份目录\nmkdir -p $BACKUP_DIR\n\n# 生成备份文件名\nTIMESTAMP=$(date +\"%Y%m%d_%H%M%S\")\nBACKUP_FILE=\"${DB_NAME}_${TIMESTAMP}.sql.gz\"\nBACKUP_PATH=\"${BACKUP_DIR}/${BACKUP_FILE}\"\n\necho \"开始备份数据库...\"\n\n# 执行备份\npg_dump -h $DB_HOST -U $DB_USER -d $DB_NAME | gzip > $BACKUP_PATH\n\nif [ $? -eq 0 ]; then\n    echo \"✅ 数据库备份成功: $BACKUP_FILE\"\n    \n    # 上传到S3\n    echo \"上传备份到S3...\"\n    aws s3 cp $BACKUP_PATH s3://$S3_BUCKET/database/\n    \n    if [ $? -eq 0 ]; then\n        echo \"✅ 备份已上传到S3\"\n        \n        # 删除本地备份文件（保留最近7天）\n        find $BACKUP_DIR -name \"*.sql.gz\" -mtime +7 -delete\n        \n        # 删除S3中的旧备份\n        aws s3 ls s3://$S3_BUCKET/database/ | while read -r line; do\n            createDate=$(echo $line | awk '{print $1\" \"$2}')\n            createDate=$(date -d \"$createDate\" +%s)\n            olderThan=$(date -d \"$RETENTION_DAYS days ago\" +%s)\n            if [[ $createDate -lt $olderThan ]]; then\n                fileName=$(echo $line | awk '{print $4}')\n                if [[ $fileName != \"\" ]]; then\n                    aws s3 rm s3://$S3_BUCKET/database/$fileName\n                    echo \"删除旧备份: $fileName\"\n                fi\n            fi\n        done\n        \n    else\n        echo \"❌ 备份上传失败\"\n        exit 1\n    fi\nelse\n    echo \"❌ 数据库备份失败\"\n    exit 1\nfi\n\necho \"备份完成！\"\n```\n\n### 数据恢复\n\n```bash\n#!/bin/bash\n# restore-database.sh\n\nset -e\n\nif [ $# -ne 1 ]; then\n    echo \"用法: $0 <backup_file>\"\n    echo \"示例: $0 quant_framework_20240101_120000.sql.gz\"\n    exit 1\nfi\n\nBACKUP_FILE=$1\nDB_HOST=\"postgres-cluster-rw\"\nDB_NAME=\"quant_framework\"\nDB_USER=\"app_user\"\nS3_BUCKET=\"your-backup-bucket\"\nTEMP_DIR=\"/tmp/restore\"\n\n# 创建临时目录\nmkdir -p $TEMP_DIR\n\necho \"开始恢复数据库...\"\necho \"备份文件: $BACKUP_FILE\"\n\n# 从S3下载备份文件\necho \"从S3下载备份文件...\"\naws s3 cp s3://$S3_BUCKET/database/$BACKUP_FILE $TEMP_DIR/\n\nif [ $? -ne 0 ]; then\n    echo \"❌ 备份文件下载失败\"\n    exit 1\nfi\n\n# 确认恢复操作\necho \"⚠️  警告：此操作将完全替换当前数据库内容！\"\nread -p \"确认继续恢复？(yes/no): \" confirm\n\nif [ \"$confirm\" != \"yes\" ]; then\n    echo \"恢复操作已取消\"\n    exit 0\nfi\n\n# 停止应用服务\necho \"停止应用服务...\"\nkubectl scale deployment quant-framework --replicas=0 -n prod\n\n# 等待服务停止\nsleep 30\n\n# 创建当前数据库备份（以防万一）\necho \"创建当前数据库备份...\"\nCURRENT_BACKUP=\"${DB_NAME}_before_restore_$(date +%Y%m%d_%H%M%S).sql.gz\"\npg_dump -h $DB_HOST -U $DB_USER -d $DB_NAME | gzip > $TEMP_DIR/$CURRENT_BACKUP\n\n# 删除现有数据库\necho \"删除现有数据库...\"\npsql -h $DB_HOST -U $DB_USER -c \"DROP DATABASE IF EXISTS $DB_NAME;\"\npsql -h $DB_HOST -U $DB_USER -c \"CREATE DATABASE $DB_NAME;\"\n\n# 恢复数据库\necho \"恢复数据库...\"\ngunzip -c $TEMP_DIR/$BACKUP_FILE | psql -h $DB_HOST -U $DB_USER -d $DB_NAME\n\nif [ $? -eq 0 ]; then\n    echo \"✅ 数据库恢复成功\"\n    \n    # 重启应用服务\n    echo \"重启应用服务...\"\n    kubectl scale deployment quant-framework --replicas=5 -n prod\n    \n    # 等待服务启动\n    kubectl rollout status deployment/quant-framework -n prod\n    \n    echo \"✅ 数据库恢复完成！\"\nelse\n    echo \"❌ 数据库恢复失败\"\n    \n    # 尝试恢复到之前的状态\n    echo \"尝试恢复到之前的状态...\"\n    psql -h $DB_HOST -U $DB_USER -c \"DROP DATABASE IF EXISTS $DB_NAME;\"\n    psql -h $DB_HOST -U $DB_USER -c \"CREATE DATABASE $DB_NAME;\"\n    gunzip -c $TEMP_DIR/$CURRENT_BACKUP | psql -h $DB_HOST -U $DB_USER -d $DB_NAME\n    \n    kubectl scale deployment quant-framework --replicas=5 -n prod\n    \n    exit 1\nfi\n\n# 清理临时文件\nrm -rf $TEMP_DIR\n\necho \"恢复操作完成！\"\n```\n\n## 安全配置\n\n### SSL/TLS配置\n\n```bash\n#!/bin/bash\n# setup-ssl.sh\n\n# 使用Let's Encrypt获取SSL证书\ncertbot certonly --nginx \\\n    -d quant-framework.com \\\n    -d www.quant-framework.com \\\n    -d api.quant-framework.com \\\n    --email admin@quant-framework.com \\\n    --agree-tos \\\n    --non-interactive\n\n# 设置自动续期\necho \"0 12 * * * /usr/bin/certbot renew --quiet\" | crontab -\n```\n\n### 网络安全\n\n```yaml\n# k8s/prod/network-policy.yaml\napiVersion: networking.k8s.io/v1\nkind: NetworkPolicy\nmetadata:\n  name: quant-framework-network-policy\n  namespace: prod\nspec:\n  podSelector:\n    matchLabels:\n      app: quant-framework\n  policyTypes:\n  - Ingress\n  - Egress\n  ingress:\n  - from:\n    - namespaceSelector:\n        matchLabels:\n          name: ingress-nginx\n    ports:\n    - protocol: TCP\n      port: 8000\n  - from:\n    - podSelector:\n        matchLabels:\n          app: prometheus\n    ports:\n    - protocol: TCP\n      port: 8000\n  egress:\n  - to:\n    - podSelector:\n        matchLabels:\n          app: postgres\n    ports:\n    - protocol: TCP\n      port: 5432\n  - to:\n    - podSelector:\n        matchLabels:\n          app: redis\n    ports:\n    - protocol: TCP\n      port: 6379\n  - to: []\n    ports:\n    - protocol: TCP\n      port: 53\n    - protocol: UDP\n      port: 53\n  - to: []\n    ports:\n    - protocol: TCP\n      port: 443\n```\n\n## 性能优化\n\n### 数据库优化\n\n```sql\n-- 创建索引\nCREATE INDEX CONCURRENTLY idx_strategies_author_id ON strategies(author_id);\nCREATE INDEX CONCURRENTLY idx_strategies_created_at ON strategies(created_at);\nCREATE INDEX CONCURRENTLY idx_backtests_strategy_id ON backtests(strategy_id);\nCREATE INDEX CONCURRENTLY idx_backtests_status ON backtests(status);\nCREATE INDEX CONCURRENTLY idx_price_data_symbol_date ON price_data(symbol, date);\n\n-- 分区表（价格数据）\nCREATE TABLE price_data_2024 PARTITION OF price_data\nFOR VALUES FROM ('2024-01-01') TO ('2025-01-01');\n\n-- 定期维护\nSET maintenance_work_mem = '1GB';\nREINDEX DATABASE quant_framework;\nVACUUM ANALYZE;\n```\n\n### 应用优化\n\n```python\n# 连接池配置\nfrom sqlalchemy.pool import QueuePool\n\nengine = create_engine(\n    DATABASE_URL,\n    poolclass=QueuePool,\n    pool_size=20,\n    max_overflow=30,\n    pool_pre_ping=True,\n    pool_recycle=3600\n)\n\n# Redis连接池\nredis_pool = redis.ConnectionPool(\n    host='redis',\n    port=6379,\n    db=0,\n    max_connections=50\n)\n\n# 缓存配置\nfrom functools import lru_cache\n\n@lru_cache(maxsize=1000)\ndef get_security_info(symbol: str):\n    # 缓存证券信息\n    pass\n```\n\n## 故障排除\n\n### 常见问题\n\n1. **服务无法启动**\n```bash\n# 检查日志\nkubectl logs deployment/quant-framework -n prod\n\n# 检查配置\nkubectl describe deployment quant-framework -n prod\n\n# 检查资源\nkubectl top pods -n prod\n```\n\n2. **数据库连接问题**\n```bash\n# 检查数据库状态\nkubectl exec -it postgres-cluster-1 -- psql -U app_user -d quant_framework -c \"SELECT 1;\"\n\n# 检查连接数\nkubectl exec -it postgres-cluster-1 -- psql -U app_user -d quant_framework -c \"SELECT count(*) FROM pg_stat_activity;\"\n```\n\n3. **性能问题**\n```bash\n# 检查慢查询\nkubectl exec -it postgres-cluster-1 -- psql -U app_user -d quant_framework -c \"SELECT query, mean_time, calls FROM pg_stat_statements ORDER BY mean_time DESC LIMIT 10;\"\n\n# 检查系统资源\nkubectl top nodes\nkubectl top pods -n prod\n```\n\n### 应急响应\n\n```bash\n#!/bin/bash\n# emergency-response.sh\n\ncase $1 in\n    \"scale-up\")\n        echo \"扩容应用实例...\"\n        kubectl scale deployment quant-framework --replicas=10 -n prod\n        ;;\n    \"scale-down\")\n        echo \"缩容应用实例...\"\n        kubectl scale deployment quant-framework --replicas=3 -n prod\n        ;;\n    \"restart\")\n        echo \"重启应用...\"\n        kubectl rollout restart deployment/quant-framework -n prod\n        ;;\n    \"maintenance\")\n        echo \"进入维护模式...\"\n        kubectl scale deployment quant-framework --replicas=0 -n prod\n        kubectl apply -f k8s/maintenance-page.yaml\n        ;;\n    \"recover\")\n        echo \"退出维护模式...\"\n        kubectl delete -f k8s/maintenance-page.yaml\n        kubectl scale deployment quant-framework --replicas=5 -n prod\n        ;;\n    *)\n        echo \"用法: $0 {scale-up|scale-down|restart|maintenance|recover}\"\n        exit 1\n        ;;\nesac\n```\n\n---\n\n*本部署指南持续更新中，如有问题请联系运维团队。*