#!/usr/bin/env python3\n\"\"\"\né‡åŒ–æŠ•èµ„ç ”ç©¶æ¡†æ¶ - å¿«é€Ÿå¯åŠ¨è„šæœ¬\n\"\"\"\n\nimport os\nimport sys\nimport subprocess\nimport time\nfrom pathlib import Path\n\ndef print_banner():\n    \"\"\"æ‰“å°å¯åŠ¨æ¨ªå¹…\"\"\"\n    banner = \"\"\"\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\nâ•‘                é‡åŒ–æŠ•èµ„ç ”ç©¶æ¡†æ¶                                â•‘\nâ•‘            Quantitative Investment Research Framework        â•‘\nâ•‘                                                              â•‘\nâ•‘  ğŸš€ å¿«é€Ÿå¯åŠ¨è„šæœ¬ - Quick Start Script                        â•‘\nâ•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\"\"\"\n    print(banner)\n\ndef check_prerequisites():\n    \"\"\"æ£€æŸ¥å‰ç½®æ¡ä»¶\"\"\"\n    print(\"\\nğŸ” æ£€æŸ¥å‰ç½®æ¡ä»¶...\")\n    \n    # æ£€æŸ¥Docker\n    try:\n        result = subprocess.run(['docker', '--version'], capture_output=True, text=True)\n        if result.returncode == 0:\n            print(\"  âœ… Docker å·²å®‰è£…\")\n        else:\n            print(\"  âŒ Docker æœªå®‰è£…æˆ–ä¸å¯ç”¨\")\n            return False\n    except FileNotFoundError:\n        print(\"  âŒ Docker æœªå®‰è£…\")\n        return False\n    \n    # æ£€æŸ¥Docker Compose\n    try:\n        result = subprocess.run(['docker-compose', '--version'], capture_output=True, text=True)\n        if result.returncode == 0:\n            print(\"  âœ… Docker Compose å·²å®‰è£…\")\n        else:\n            print(\"  âŒ Docker Compose æœªå®‰è£…æˆ–ä¸å¯ç”¨\")\n            return False\n    except FileNotFoundError:\n        print(\"  âŒ Docker Compose æœªå®‰è£…\")\n        return False\n    \n    # æ£€æŸ¥ç«¯å£å ç”¨\n    ports_to_check = [3000, 8000, 5432, 6379]\n    for port in ports_to_check:\n        if is_port_in_use(port):\n            print(f\"  âš ï¸  ç«¯å£ {port} å·²è¢«å ç”¨ï¼Œå¯èƒ½ä¼šå¯¼è‡´å†²çª\")\n        else:\n            print(f\"  âœ… ç«¯å£ {port} å¯ç”¨\")\n    \n    return True\n\ndef is_port_in_use(port):\n    \"\"\"æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨\"\"\"\n    import socket\n    with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:\n        return s.connect_ex(('localhost', port)) == 0\n\ndef setup_environment():\n    \"\"\"è®¾ç½®ç¯å¢ƒ\"\"\"\n    print(\"\\nâš™ï¸  è®¾ç½®ç¯å¢ƒé…ç½®...\")\n    \n    # æ£€æŸ¥ç¯å¢ƒé…ç½®æ–‡ä»¶\n    env_file = Path('.env')\n    if not env_file.exists():\n        print(\"  ğŸ“ åˆ›å»ºç¯å¢ƒé…ç½®æ–‡ä»¶...\")\n        # å¤åˆ¶ç¤ºä¾‹é…ç½®\n        if Path('.env.example').exists():\n            subprocess.run(['cp', '.env.example', '.env'])\n            print(\"  âœ… ç¯å¢ƒé…ç½®æ–‡ä»¶å·²åˆ›å»º\")\n        else:\n            # åˆ›å»ºåŸºæœ¬é…ç½®\n            with open('.env', 'w') as f:\n                f.write(\"\"\"\n# é‡åŒ–æŠ•èµ„ç ”ç©¶æ¡†æ¶ç¯å¢ƒé…ç½®\nENVIRONMENT=development\nDEBUG=true\n\n# æ•°æ®åº“é…ç½®\nDATABASE_URL=postgresql://postgres:password@postgres:5432/quant_framework_dev\n\n# Redisé…ç½®\nREDIS_URL=redis://redis:6379/0\n\n# å®‰å…¨é…ç½®\nSECRET_KEY=dev-secret-key-change-in-production\nACCESS_TOKEN_EXPIRE_MINUTES=1440\n\n# æ•°æ®æºé…ç½®ï¼ˆè¯·æ›¿æ¢ä¸ºçœŸå®çš„tokenï¼‰\nTUSHARE_TOKEN=your-tushare-token-here\n\n# æ—¥å¿—é…ç½®\nLOG_LEVEL=INFO\nLOG_FILE=logs/app.log\n\"\"\")\n            print(\"  âœ… åŸºæœ¬ç¯å¢ƒé…ç½®æ–‡ä»¶å·²åˆ›å»º\")\n    else:\n        print(\"  âœ… ç¯å¢ƒé…ç½®æ–‡ä»¶å·²å­˜åœ¨\")\n    \n    # åˆ›å»ºå¿…è¦çš„ç›®å½•\n    directories = ['logs', 'data/cache', 'test_reports', 'validation_reports']\n    for directory in directories:\n        Path(directory).mkdir(parents=True, exist_ok=True)\n    print(\"  âœ… å¿…è¦ç›®å½•å·²åˆ›å»º\")\n\ndef start_services():\n    \"\"\"å¯åŠ¨æœåŠ¡\"\"\"\n    print(\"\\nğŸš€ å¯åŠ¨æœåŠ¡...\")\n    \n    try:\n        # å¯åŠ¨å¼€å‘ç¯å¢ƒ\n        print(\"  ğŸ“¦ å¯åŠ¨Dockerå®¹å™¨...\")\n        result = subprocess.run(\n            ['docker-compose', '-f', 'docker-compose.dev.yml', 'up', '-d'],\n            capture_output=True,\n            text=True\n        )\n        \n        if result.returncode == 0:\n            print(\"  âœ… Dockerå®¹å™¨å¯åŠ¨æˆåŠŸ\")\n        else:\n            print(f\"  âŒ Dockerå®¹å™¨å¯åŠ¨å¤±è´¥: {result.stderr}\")\n            return False\n        \n        # ç­‰å¾…æœåŠ¡å°±ç»ª\n        print(\"  â³ ç­‰å¾…æœåŠ¡å°±ç»ª...\")\n        time.sleep(30)\n        \n        # æ£€æŸ¥æœåŠ¡çŠ¶æ€\n        result = subprocess.run(\n            ['docker-compose', '-f', 'docker-compose.dev.yml', 'ps'],\n            capture_output=True,\n            text=True\n        )\n        \n        if 'Up' in result.stdout:\n            print(\"  âœ… æœåŠ¡è¿è¡Œæ­£å¸¸\")\n        else:\n            print(\"  âš ï¸  éƒ¨åˆ†æœåŠ¡å¯èƒ½æœªæ­£å¸¸å¯åŠ¨\")\n        \n        return True\n        \n    except Exception as e:\n        print(f\"  âŒ å¯åŠ¨æœåŠ¡æ—¶å‡ºé”™: {e}\")\n        return False\n\ndef initialize_database():\n    \"\"\"åˆå§‹åŒ–æ•°æ®åº“\"\"\"\n    print(\"\\nğŸ—„ï¸  åˆå§‹åŒ–æ•°æ®åº“...\")\n    \n    try:\n        # ç­‰å¾…æ•°æ®åº“å°±ç»ª\n        print(\"  â³ ç­‰å¾…æ•°æ®åº“å°±ç»ª...\")\n        time.sleep(10)\n        \n        # è¿è¡Œæ•°æ®åº“è¿ç§»\n        print(\"  ğŸ“Š è¿è¡Œæ•°æ®åº“è¿ç§»...\")\n        result = subprocess.run(\n            ['docker-compose', '-f', 'docker-compose.dev.yml', 'exec', '-T', 'backend', \n             'python', 'scripts/migrate.py', 'upgrade'],\n            capture_output=True,\n            text=True\n        )\n        \n        if result.returncode == 0:\n            print(\"  âœ… æ•°æ®åº“è¿ç§»å®Œæˆ\")\n        else:\n            print(f\"  âš ï¸  æ•°æ®åº“è¿ç§»å¯èƒ½å¤±è´¥: {result.stderr}\")\n        \n        # åˆå§‹åŒ–åŸºç¡€æ•°æ®\n        print(\"  ğŸ“ åˆå§‹åŒ–åŸºç¡€æ•°æ®...\")\n        result = subprocess.run(\n            ['docker-compose', '-f', 'docker-compose.dev.yml', 'exec', '-T', 'backend',\n             'python', 'scripts/init_data.py', 'init'],\n            capture_output=True,\n            text=True\n        )\n        \n        if result.returncode == 0:\n            print(\"  âœ… åŸºç¡€æ•°æ®åˆå§‹åŒ–å®Œæˆ\")\n        else:\n            print(f\"  âš ï¸  åŸºç¡€æ•°æ®åˆå§‹åŒ–å¯èƒ½å¤±è´¥: {result.stderr}\")\n        \n        return True\n        \n    except Exception as e:\n        print(f\"  âŒ æ•°æ®åº“åˆå§‹åŒ–æ—¶å‡ºé”™: {e}\")\n        return False\n\ndef run_health_check():\n    \"\"\"è¿è¡Œå¥åº·æ£€æŸ¥\"\"\"\n    print(\"\\nğŸ¥ è¿è¡Œå¥åº·æ£€æŸ¥...\")\n    \n    # æ£€æŸ¥å„ä¸ªæœåŠ¡çš„å¥åº·çŠ¶æ€\n    services = [\n        ('å‰ç«¯æœåŠ¡', 'http://localhost:3000'),\n        ('åç«¯API', 'http://localhost:8000/health'),\n        ('APIæ–‡æ¡£', 'http://localhost:8000/docs')\n    ]\n    \n    all_healthy = True\n    \n    for service_name, url in services:\n        try:\n            import urllib.request\n            urllib.request.urlopen(url, timeout=5)\n            print(f\"  âœ… {service_name}: {url}\")\n        except Exception:\n            print(f\"  âŒ {service_name}: {url} (ä¸å¯è®¿é—®)\")\n            all_healthy = False\n    \n    return all_healthy\n\ndef print_success_info():\n    \"\"\"æ‰“å°æˆåŠŸä¿¡æ¯\"\"\"\n    success_message = \"\"\"\nğŸ‰ é‡åŒ–æŠ•èµ„ç ”ç©¶æ¡†æ¶å¯åŠ¨æˆåŠŸï¼\n\nğŸ“± è®¿é—®åœ°å€:\n  â€¢ å‰ç«¯ç•Œé¢: http://localhost:3000\n  â€¢ åç«¯API:  http://localhost:8000\n  â€¢ APIæ–‡æ¡£:  http://localhost:8000/docs\n  â€¢ ç®¡ç†åå°: http://localhost:8000/admin\n\nğŸ‘¤ é»˜è®¤è´¦æˆ·:\n  â€¢ ç”¨æˆ·å: admin\n  â€¢ å¯†ç : admin123\n\nğŸ“š å¿«é€Ÿå¼€å§‹:\n  1. è®¿é—®å‰ç«¯ç•Œé¢è¿›è¡Œç”¨æˆ·æ³¨å†Œ\n  2. åˆ›å»ºä½ çš„ç¬¬ä¸€ä¸ªé‡åŒ–ç­–ç•¥\n  3. è¿è¡Œå›æµ‹éªŒè¯ç­–ç•¥æ•ˆæœ\n  4. æŸ¥çœ‹è¯¦ç»†çš„å›æµ‹æŠ¥å‘Š\n\nğŸ› ï¸  å¸¸ç”¨å‘½ä»¤:\n  â€¢ æŸ¥çœ‹æœåŠ¡çŠ¶æ€: docker-compose -f docker-compose.dev.yml ps\n  â€¢ æŸ¥çœ‹æ—¥å¿—: docker-compose -f docker-compose.dev.yml logs -f\n  â€¢ åœæ­¢æœåŠ¡: docker-compose -f docker-compose.dev.yml down\n  â€¢ é‡å¯æœåŠ¡: docker-compose -f docker-compose.dev.yml restart\n\nğŸ“– æ›´å¤šä¿¡æ¯:\n  â€¢ ç”¨æˆ·æ‰‹å†Œ: docs/user_guide.md\n  â€¢ å¼€å‘æŒ‡å—: docs/developer_guide.md\n  â€¢ APIæ–‡æ¡£: docs/api_documentation.md\n\nğŸ†˜ éœ€è¦å¸®åŠ©?\n  â€¢ GitHub Issues: https://github.com/your-org/quant-framework/issues\n  â€¢ æŠ€æœ¯æ”¯æŒ: support@quantframework.com\n\"\"\"\n    print(success_message)\n\ndef print_failure_info():\n    \"\"\"æ‰“å°å¤±è´¥ä¿¡æ¯\"\"\"\n    failure_message = \"\"\"\nâŒ å¯åŠ¨è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜\n\nğŸ”§ æ•…éšœæ’é™¤:\n  1. æ£€æŸ¥Dockeræ˜¯å¦æ­£å¸¸è¿è¡Œ\n  2. ç¡®ä¿æ‰€éœ€ç«¯å£æœªè¢«å ç”¨ (3000, 8000, 5432, 6379)\n  3. æ£€æŸ¥ç£ç›˜ç©ºé—´æ˜¯å¦å……è¶³\n  4. æŸ¥çœ‹è¯¦ç»†é”™è¯¯æ—¥å¿—\n\nğŸ“‹ æ‰‹åŠ¨å¯åŠ¨æ­¥éª¤:\n  1. docker-compose -f docker-compose.dev.yml up -d\n  2. ç­‰å¾…æœåŠ¡å¯åŠ¨ (çº¦30ç§’)\n  3. docker-compose -f docker-compose.dev.yml exec backend python scripts/migrate.py upgrade\n  4. docker-compose -f docker-compose.dev.yml exec backend python scripts/init_data.py init\n\nğŸ†˜ è·å–å¸®åŠ©:\n  â€¢ æŸ¥çœ‹æ—¥å¿—: docker-compose -f docker-compose.dev.yml logs\n  â€¢ æ£€æŸ¥çŠ¶æ€: docker-compose -f docker-compose.dev.yml ps\n  â€¢ é‡æ–°å¯åŠ¨: docker-compose -f docker-compose.dev.yml restart\n\"\"\"\n    print(failure_message)\n\ndef main():\n    \"\"\"ä¸»å‡½æ•°\"\"\"\n    print_banner()\n    \n    # æ£€æŸ¥å‰ç½®æ¡ä»¶\n    if not check_prerequisites():\n        print(\"\\nâŒ å‰ç½®æ¡ä»¶æ£€æŸ¥å¤±è´¥ï¼Œè¯·å®‰è£…å¿…è¦çš„è½¯ä»¶åé‡è¯•\")\n        sys.exit(1)\n    \n    # è®¾ç½®ç¯å¢ƒ\n    setup_environment()\n    \n    # å¯åŠ¨æœåŠ¡\n    if not start_services():\n        print_failure_info()\n        sys.exit(1)\n    \n    # åˆå§‹åŒ–æ•°æ®åº“\n    if not initialize_database():\n        print(\"\\nâš ï¸  æ•°æ®åº“åˆå§‹åŒ–å¯èƒ½å¤±è´¥ï¼Œä½†æœåŠ¡ä»å¯èƒ½æ­£å¸¸è¿è¡Œ\")\n    \n    # è¿è¡Œå¥åº·æ£€æŸ¥\n    if run_health_check():\n        print_success_info()\n    else:\n        print(\"\\nâš ï¸  éƒ¨åˆ†æœåŠ¡å¯èƒ½æœªæ­£å¸¸å¯åŠ¨ï¼Œè¯·æ£€æŸ¥æœåŠ¡çŠ¶æ€\")\n        print_failure_info()\n\nif __name__ == \"__main__\":\n    try:\n        main()\n    except KeyboardInterrupt:\n        print(\"\\n\\nâ¹ï¸  å¯åŠ¨è¿‡ç¨‹è¢«ç”¨æˆ·ä¸­æ–­\")\n        sys.exit(130)\n    except Exception as e:\n        print(f\"\\n\\nğŸ’¥ å¯åŠ¨è¿‡ç¨‹ä¸­å‘ç”Ÿæœªé¢„æœŸçš„é”™è¯¯: {e}\")\n        sys.exit(1)\n